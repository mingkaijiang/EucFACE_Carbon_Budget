---
title: "EucFACE Carbon Synthesis Project Report"
author: "Mingkai Jiang"
date: "2/20/2018"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: united
    
---

# 1. Description

This is a progress report of the EucFACE carbon (C) synthesis project. All results presented in this report are linked with the code and the data. 

This file attempts to summarize C-related pools, fluxes, their CO2 treatment and inter-ring variability, and the temporal patterns. 

All the data used in this study will be made available on HIEv. 

# 2. Methods 
### 2.1 Calculating NEP
Here, we are trying to use 3 possible ways to compute **Net Ecosystem Productivity**, which are:

    - Change in pools
    - Total in fluxes - total out fluxes
    - NPP - Rh

### 2.2 Units
All pools are in units of g C m-2, and all fluxes are in units of mg C m-2 d-1, and will be summarized as g C m-2 yr-1 in the summary table. 

<br/>

### 2.3 Input functions and variables
#### 2.3.1 Source the functions
``` {r, warning=F, message=F}
    #### Source functions and packages
    source("R/prepare.R")

    #### Set plotting option
    ##   if = T, plot time series figure of individual variable 
    ##           else, no plots
    plot_option = T
    
    ring_colours <- c("#FF7F50", "#00FFFF", "#6495ED",
                      "#FF4040", "#8B0000", "#0000FF")
    
    library(knitr)
    opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)

```

<br/>

#### 2.3.2 Pre-defined constants
``` {r, echo=F, warning=F, message=F}


    constDF <- data.frame(Abbreviation = c("c_fraction",
                                           "c_fraction_fr",
                                           "c_fraction_lp",
                                           "frass_basket_area",
                                           "ring_diameter",
                                           "ring_area",
                                           "wood_density",
                                           "ndays_in_month",
                                           "strip_area",
                                           "ccost"),
                          Value = c(c_fraction,
                                    c_fraction_fr,
                                    c_fraction_lp,
                                    frass_basket_area,
                                    ring_diameter,
                                    ring_area,
                                    wood_density,
                                    ndays_in_month,
                                    strip_area,
                                    ccost),
                          Definition = c("Fraction of C in dry matter",
                                         "Fraction of C in fineroot dry matter",
                                         "Fraction of C in lerp dry matter",
                                         "Frass basket area (m2)",
                                         "FACE ring diameter (m)",
                                         "FACE ring ground area (m2)",
                                         "Wood density (g cm-3), averaged global entry",
                                         "number of days in a month",
                                         "Understorey harvest strip area (m2)",
                                         "C cost of growth, i.e. growth respiration")
    )
    
    kable(constDF, digits=2)
```

<br/>

#### 2.3.3 Overstorey LAI
``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"} 
    ### LAI
    lai_variable <- make_lai_variable()
    
    ### make the plot
    p <- ggplot(lai_variable,
                aes(Date, lai_variable, color=factor(Ring))) +   
            geom_point(size = 1.5) + geom_line() + 
            xlab("Date") + ylab("LAI") + 
            scale_color_manual(values=ring_colours, name="Ring")
    
    if (plot_option) {
            plot(p)
    }

```

<br/>

#### 2.3.4 Overstorey SLA
``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"} 
    
    ### LAI
    sla_variable <- make_sla_variable()

   ### make the plot
    p <- ggplot(sla_variable,
                aes(Date, sla_variable, color=factor(Ring))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("SLA") + 
            scale_color_manual(values=ring_colours, name="Ring")
    
    if (plot_option) {
            plot(p)
    }
```

<br/>

#### 2.3.5 Understorey SLA
``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"} 
    
    ### LAI
    understorey_sla_variable <- make_understorey_sla_variable()

   ### make the plot
    p <- ggplot(sla_variable,
                aes(Date, sla_variable, color=factor(Ring))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("SLA") + 
            scale_color_manual(values=ring_colours, name="Ring")
    
    if (plot_option) {
            plot(p)
    }
```

<br/>

#### 2.3.6 Soil bulk density
``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"} 
    ### Soil bulk density at 3 depths
    ### unit is kg m-3
    soil_bulk_density_variable <- make_soil_bulk_density()

   ### make the plot
    p <- ggplot(soil_bulk_density_variable,
                aes(ring, bulk_density_kg_m3)) +   
            geom_bar(stat = "identity", aes(fill=Depth),
                     position="dodge") +
            xlab("Ring") + ylab("Soil bulk density (kg m-3)")
    
    if (plot_option) {
            plot(p)
    }
```

<br/>
<br/>

# 3. Method **Pools**
### 3.1 Soil C pool
``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"} 
    soil_c_pool <- make_soil_carbon_pool(bk_density=soil_bulk_density_variable,
                                         return="all_depths")

   ### make the plot
    p <- ggplot(soil_c_pool,
                aes(Date, soil_carbon_pool, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Soil C Pool (g m-2)") + 
            scale_color_manual(values=ring_colours, name="Ring")
    
    if (plot_option) {
            plot(p)
    }
```

### Leaf C Pool
``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"} 
    leaf_c_pool <- make_leaf_pool(lai_variable, sla_variable, c_fraction)

   ### make the plot
    p <- ggplot(leaf_c_pool,
                aes(Date, leaf_pool, color=factor(Ring))) +   
            geom_point(size = 2.5) + geom_line() + 
            xlab("Date") + ylab("Canopy C Pool (g m-2)") + 
            scale_color_manual(values=ring_colours, name="Ring")
    
    if (plot_option) {
            plot(p)
    }
```

### Wood C Pool

This wood C pool is estimated based on allometric relationship with height.

``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"} 
    wood_c_pool <- make_wood_pool(ring_area,c_fraction)

   ### make the plot
    p <- ggplot(wood_c_pool,
                aes(Date, wood_pool, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Wood C Pool (g m-2)") + 
            scale_color_manual(values=ring_colours, name="Ring")
    
    if (plot_option) {
            plot(p)
    }
```


Below is a 2nd way of estimating wood C pool, based on wood volume information.

``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"} 
    wood_pool_2 <- make_wood_pool_2(ring_area,c_fraction,wood_density)

   ### make the plot
    p <- ggplot(wood_pool_2,
                aes(Date, wood_pool_2, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Wood C Pool (g m-2)") + 
            scale_color_manual(values=ring_colours, name="Ring")
    
    if (plot_option) {
            plot(p)
    }
```


Here we need to compare the two methods:
``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"} 
    wood <- summaryBy(wood_pool~Ring, data=wood_c_pool, FUN=mean, keep.names=T, na.rm=T)
    wood$wood_pool2 <- wood_pool_2$wood_pool_2
    colnames(wood) <- c("Ring", "Height", "Volume")
    plotDF <- melt(wood, id="Ring")
    
    
   ### make the plot
    p <- ggplot(plotDF,
                aes(Ring, value)) +   
            geom_bar(stat = "identity", aes(fill=variable),
                     position="dodge") +
            xlab("Ring") + ylab("Wood C Pool (g C m-2)")
    
    if (plot_option) {
            plot(p)
    }
```

How do we reconcile the difference in estimated wood c pool?

### Fineroot C Pool
``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"} 
    fineroot_c_pool <- make_fineroot_pool(c_fraction_fr)

   ### make the plot
    p <- ggplot(fineroot_c_pool,
                aes(Date, fineroot_pool, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Fineroot C Pool (g m-2)") + 
            scale_color_manual(values=ring_colours, name="Ring")
    
    if (plot_option) {
            plot(p)
    }
```


### Coarse root C Pool

Here, we have two ways of estimating coarse root C pool, based on allometric relationships for:

    - 1. Eucalyptus nitens.
    - 2. P. radiata
    
I think it makes more sense to use the 1st method, so just show results based on it.

``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"} 
    coarse_root_c_pool_1 <- make_coarse_root_pool_1(c_fraction) 

   ### make the plot
    p <- ggplot(coarse_root_c_pool_1 ,
                aes(Date, coarse_root_pool, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Coarse root C Pool (g m-2)") + 
            scale_color_manual(values=ring_colours, name="Ring")
    
    if (plot_option) {
            plot(p)
    }
```

### Understorey aboveground C pool

There are two ways of estimating understory aboveground biomass, 1. Harvest data, and 2) Non-destructive, Stereo Camera estimates. 

The harvest data is provided at quarterly timestep, based on harvesting biomass sourced from a strip with area of 0.1 m2. It includes grasses and herbs. It provides % live and % dead information. 

The stereo camera biomass estimate has more temporal coverage, and is estimated based on height and % coverage images (extrapolated based on pre-calibrated height-biomass relationship). The stereo camera estimates include also shrubs. 

#### Harvest estimate of understorey aboveground C pool
``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"} 
    understorey_aboveground_c_pool <- make_understorey_aboveground_c_pool(c_fraction)

   ### make the plot
    p <- ggplot(understorey_aboveground_c_pool,
                aes(Date, Total_g_C_m2, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Understorey C Pool (g m-2)") + 
            scale_color_manual(values=ring_colours, name="Ring")
    
    if (plot_option) {
            plot(p)
    }
```


#### Stereo camera estimates of understorey aboveground C pool
``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"} 
    understorey_aboveground_c_pool_2 <- make_understorey_aboveground_c_pool_2(c_fraction)

   ### make the plot
    p <- ggplot(understorey_aboveground_c_pool_2,
                aes(Date, Total_g_C_m2, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Understorey C Pool (g m-2)") + 
            scale_color_manual(values=ring_colours, name="Ring")
    
    if (plot_option) {
            plot(p)
    }
```

#### Compare the methods
``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"} 
    DF1 <- summaryBy(Total_g_C_m2~Date, data=understorey_aboveground_c_pool, 
                     FUN=mean, na.rm=T, keep.names=T)
    DF2 <- summaryBy(Total_g_C_m2~Date, data=understorey_aboveground_c_pool_2, 
                     FUN=mean, na.rm=T, keep.names=T)
    
    date.list <- unique(c(DF1$Date, DF2$Date))
    myDF <- data.frame(date.list, NA, NA)
    colnames(myDF) <- c("Date", "DF1", "DF2")
    
    for (i in DF1$Date) {
        myDF[myDF$Date == i, "DF1"] <- DF1[DF1$Date == i, "Total_g_C_m2"]
    }
    
    for (i in DF2$Date) {
        myDF[myDF$Date == i, "DF2"] <- DF2[DF2$Date == i, "Total_g_C_m2"]
    }
    
    plotDF <- melt(myDF, id.var="Date")

   ### make the plot
   p <- ggplot(plotDF, aes(Date,value)) + 
            geom_point() + 
            stat_smooth() +
            facet_wrap(~variable)
        
    if (plot_option) {
            plot(p)
    }
```

The temporal trend is similar, but the estimated biomass is different, with non-destructive method estimated higher biomass than harvesting estimates. 

#### Check % live result
``` {r, echo=F, warning=F, message=F, fig.width = 7, fig.align="center"}
    understorey_live_percent <- make_understorey_percent_live_estimate()

    p <- ggplot(understorey_live_percent, aes(Date, percent_live, color=factor(Ring))) +
        geom_line() + geom_point(size=5) +
        xlab("Date") + ylab("Understorey % live") + 
            scale_color_manual(values=ring_colours, name="Ring")
    if (plot_option) {
            plot(p)
    }

```

### Microbial C Pool

The microbial C pool is for top 10 cm of soil only, whereas soil C pool is for top 30 cm. 
``` {r, echo=F, warning=F, message=F, fig.width = 7, fig.align="center"}
    microbial_c_pool <- make_microbial_pool(soil_bulk_density_variable)

    p <- ggplot(microbial_c_pool, aes(Date, microbial_pool, color=factor(Ring))) +
        geom_line() + geom_point(size=5) +
        xlab("Date") + ylab("Microbial C Pool (g m-2)") + 
            scale_color_manual(values=ring_colours, name="Ring")
    if (plot_option) {
            plot(p)
    }

```


### Standing dead pool

``` {r, echo=F, warning=F, message=F, fig.width = 7, fig.align="center"}
    standing_dead_c_pool <- make_standing_dead_c_pool(ring_area=ring_area,
                                                       c_frac=c_fraction)

    p <- ggplot(standing_dead_c_pool, aes(Date, wood_pool, color=factor(Ring))) +
        geom_line() + geom_point(size=5) +
        xlab("Date") + ylab("Standing Dead C Pool (g m-2)") + 
            scale_color_manual(values=ring_colours, name="Ring")
    if (plot_option) {
            plot(p)
    }

```

<br/>
<br/>

# 4. Method **Inout**

### Overstorey GPP flux

This is MAESPA simulation results, parameterized based on ring-specific data.

``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"}

    overstorey_gpp_flux <- make_overstorey_gpp_flux()

    ### make the plot
    p <- ggplot(overstorey_gpp_flux ,
                aes(year, GPP, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Year") + ylab("Overstorey GPP flux (g m-2 yr-1)") + 
            scale_color_manual(values=ring_colours, name="Ring")
    
    if (plot_option) {
            plot(p)
    }
```

### Understorey GPP flux

This is estimated based on overstorey GPP and multiple it by a fixed coefficient (i.e. 0.3). 

``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"}

    understorey_gpp_flux <- make_understorey_GPP_flux()

    ### make the plot
    p <- ggplot(understorey_gpp_flux,
                aes(year, GPP, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Year") + ylab("Understorey GPP flux (g m-2 yr-1)") + 
            scale_color_manual(values=ring_colours, name="Ring")
    
    if (plot_option) {
            plot(p)
    }
```


### Overstorey leaf respiration flux

This is MAESPA simulation output, parameterized based on ring-specific data.

``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"}

    overstorey_leaf_respiration_flux <- make_overstorey_leaf_respiration_flux()

    ### make the plot
    p <- ggplot(overstorey_leaf_respiration_flux,
                aes(year, Rfoliage, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Year") + ylab("Overstorey respiration flux (g m-2 yr-1)") + 
            scale_color_manual(values=ring_colours, name="Ring")
    
    if (plot_option) {
            plot(p)
    }
```



### Root respiration flux

Assume all root respiration is fineroot respiration and there is no coarse root respiration.

``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center", results="hide"}

    root_respiration_flux <- make_root_respiration_flux(fineroot_c_pool)

    ### make the plot
    p <- ggplot(root_respiration_flux,
                aes(Date, root_respiration_flux, color=factor(Ring))) +   
            geom_point(size = 1) + geom_line() + 
            xlab("Date") + ylab("Root respiration flux (mg m-2 d-1)") + 
            scale_color_manual(values=ring_colours, name="Ring")
    
    if (plot_option) {
            plot(p)
    }
```

Here, root respiration is scaled by a Q10 function with soil temperature based on data derived from Whole Tree Chamber exmperiment 3. 

The Q10 equation writes as:

$$R_{root} = 1.73 C_{root} 2.26^{(T_{soil} - 15) \over 10}$$


### Understorey respiration flux

Here, since we don't have direct measurement of understorey respiration flux, we have to use literature value of dark respiration of Microlaena. we can calculate understorey respiration flux based on two methods:

    - fixed coefficient
    - Scaling with temperature
    
Below is the estimate of understorey respiration flux based on cue approach. 

``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"}
    understorey_respiration_flux <- make_understorey_respiration_flux(c_pool=understorey_aboveground_c_pool,
                                                                  c_frac=c_fraction,
                                                                  gpp=understorey_gpp_flux,
                                                                  assumption="cue")

   ### make the plot
    p <- ggplot(understorey_respiration_flux,
                aes(Date, respiration, color=factor(Ring))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Understorey respiration flux (mg m-2 d-1)") + 
            scale_color_manual(values=ring_colours, name="Ring")
    
    if (plot_option) {
            plot(p)
    }
```


### Herbivore respiration flux
``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"}
    
    frass_production_flux <- make_frass_production_flux()

    herbivory_leaf_consumption_flux <- make_herbivory_leaf_consumption_flux(sla=sla_variable, 
                                                                        frass_flux=frass_production_flux)

    herbivory_respiration_flux <- make_herbivory_respiration_flux(leaf_consumed=herbivory_leaf_consumption_flux,
                                                              frass_prod=frass_production_flux)


   ### make the plot
    p <- ggplot(herbivory_respiration_flux,
                aes(Date, respiration_flux, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Herbivory respiration flux (mg m-2 d-1)") + 
            scale_color_manual(values=ring_colours, name="Ring")
    
    if (plot_option) {
            plot(p)
    }
```

### Soil respiration flux
``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center", results="hide"} 
    soil_respiration_flux <- make_soil_respiration_flux()

   ### make the plot
    p <- ggplot(soil_respiration_flux,
                aes(Date, soil_respiration_flux, color=factor(Ring))) +   
            geom_point(size = 1) + geom_line() + 
            xlab("Date") + ylab("Soil Respiration Flux (mg m-2 d-1)") + 
            scale_color_manual(values=ring_colours, name="Ring")
    
    if (plot_option) {
            plot(p)
    }
```

### DOC Flux
``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"} 
    doc_leaching_flux <- make_doc_leaching_flux(return="deep")

   ### make the plot
    p <- ggplot(doc_leaching_flux,
                aes(Date, doc_leaching_flux, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("DOC Flux (mg m-2 d-1)") + 
            scale_color_manual(values=ring_colours, name="Ring")
    
    if (plot_option) {
            plot(p)
    }
```

### CH4 flux

Still working on getting the parameters right!

``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"} 
    #methane_c_flux <- make_methane_flux()

   #### make the plot
    #p <- ggplot(doc_leaching_flux,
    #            aes(Date, doc_leaching_flux, color=factor(Ring))) +   
    #        geom_point(size = 5) + geom_line() + 
    #        xlab("Date") + ylab("DOC Flux (mg m-2 d-1)") + 
    #        scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
    #                                    "#FF4040", "#8B0000", "#0000FF"))
    #
    #if (plot_option) {
    #        plot(p)
    #}
```

<br/>
<br/>

# 5. Method **NPP**
### Leaf Litter Flux
``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"} 
    leaflitter_flux <- make_leaflitter_flux(c_fraction)

   ### make the plot
    p <- ggplot(leaflitter_flux,
                aes(Date, leaf_flux, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Leaf Litter Flux (mg m-2 d-1)") + 
            scale_color_manual(values=ring_colours, name="Ring")
    
    if (plot_option) {
            plot(p)
    }
```

### Leaf, twigs, seeds and bark litter flux comparison
``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"} 
    r <- c(1:6)
    myDF <- data.frame(r, NA, NA, NA, NA)
    colnames(myDF) <- c("Ring", "twig_flux", "bark_flux", "seed_flux", "leaf_flux")
    for (i in r) {
        myDF[myDF$Ring == i, "twig_flux"] <- with(leaflitter_flux[leaflitter_flux$Ring ==i,],
                                                  sum(twig_flux*ndays)/sum(ndays)) * 365/1000
        myDF[myDF$Ring == i, "bark_flux"] <- with(leaflitter_flux[leaflitter_flux$Ring ==i,],
                                                  sum(bark_flux*ndays)/sum(ndays)) * 365/1000
        myDF[myDF$Ring == i, "seed_flux"] <- with(leaflitter_flux[leaflitter_flux$Ring ==i,],
                                                  sum(seed_flux*ndays)/sum(ndays)) * 365/1000
        myDF[myDF$Ring == i, "leaf_flux"] <- with(leaflitter_flux[leaflitter_flux$Ring ==i,],
                                                  sum(leaf_flux*ndays)/sum(ndays)) * 365/1000
    }
    plotDF <- melt(myDF, id="Ring")

   ### make the plot
    p <- ggplot(plotDF, aes(Ring, value)) +   
                    geom_bar(stat = "identity", aes(fill=variable),
                    position="dodge") +
                xlab("Ring") + ylab("Litter Flux (g m-2 yr-1)")
    
    if (plot_option) {
            plot(p)
    }
```

### Wood Production Flux
``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"} 
    wood_production_flux <- make_wood_production_flux(wood_c_pool)

   ### make the plot
    p <- ggplot(wood_production_flux,
                aes(Date, wood_production_flux, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Wood Production Flux (mg m-2 d-1)") + 
            scale_color_manual(values=ring_colours, name="Ring")
    
    if (plot_option) {
            plot(p)
    }
```

### Fineroot Production Flux
``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"} 
    fineroot_production_flux <- make_fineroot_production_flux(c_fraction_fr)

   ### make the plot
    p <- ggplot(fineroot_production_flux,
                aes(Date, fineroot_production_flux, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Fineroot Production Flux (mg m-2 d-1)") + 
            scale_color_manual(values=ring_colours, name="Ring")
    
    if (plot_option) {
            plot(p)
    }
```


### Coarse root Production Flux
``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"} 
    coarse_root_production_flux_1 <- make_coarse_root_production_flux(coarse_root_c_pool_1) 

   ### make the plot
    p <- ggplot(coarse_root_production_flux_1,
                aes(Date, coarse_root_production_flux, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Coarse root Production Flux (mg m-2 d-1)") + 
            scale_color_manual(values=ring_colours, name="Ring")
    
    if (plot_option) {
            plot(p)
    }
```


### Frass Production Flux
``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"} 

    frass_production_flux <- make_frass_production_flux()

    ### make the plot
    p <- ggplot(frass_production_flux,
                aes(Date, frass_production_flux, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Frass Production Flux (mg m-2 d-1)") + 
            scale_color_manual(values=ring_colours, name="Ring")
    
    if (plot_option) {
            plot(p)
    }
```

### Herbivory leaf consumption flux
``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"}

    herbivory_leaf_consumption_flux <- make_herbivory_leaf_consumption_flux(sla=sla_variable, 
                                                                            frass_flux=frass_production_flux)

    ### make the plot
    p <- ggplot(herbivory_leaf_consumption_flux,
                aes(Date, herbivory_leaf_consumption_flux, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Herbivory leaf consumption flux (mg m-2 d-1)") + 
            scale_color_manual(values=ring_colours, name="Ring")
    
    if (plot_option) {
            plot(p)
    }
```

### Lerp Production Flux
``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"} 
    lerp_production_flux <- make_lerp_production_flux(c_fraction_lp)

   ### make the plot
    p <- ggplot(lerp_production_flux,
                aes(Date, lerp_production_flux, color=factor(Ring))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Lerp Production Flux (mg m-2 d-1)") + 
            scale_color_manual(values=ring_colours, name="Ring")
    
    if (plot_option) {
            plot(p)
    }
```

### Understorey aboveground production flux
``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"} 
    understorey_aboveground_production_flux <- make_understorey_aboveground_production_flux(c_fraction)

   ### make the plot
    p <- ggplot(understorey_aboveground_production_flux,
                aes(Date, understorey_production_flux, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() +
            xlab("Date") + ylab("Understorey Production Flux (mg m-2 d-1)") + 
            scale_color_manual(values=ring_colours, name="Ring")
    
    if (plot_option) {
            plot(p)
    }
```

Here I am using the harvest esimates to extrapolate understorey production. 

### Heterotrophic respiration flux
``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"} 
    heterotrophic_respiration_flux <- make_heterotrophic_respiration_flux(soil_respiration_flux, 
                                                                      root_respiration_flux)

   ### make the plot
    p <- ggplot(heterotrophic_respiration_flux,
                aes(Date, heterotrophic_respiration_flux, color=factor(Ring))) +   
            geom_point(size = 1) + geom_line() +
            xlab("Date") + ylab("Heterotrophic respiration flux (mg m-2 d-1)") + 
            scale_color_manual(values=ring_colours, name="Ring")
    
    if (plot_option) {
            plot(p)
    }
```

<br/>
<br/>

# 6. Summary tables
### 6.1 Overall summary
Here I am providing an overall summary of the results (ignoring ring and years). The tables below include summaries of pools and fluxes with notes highlighting data uncertainty, missing data, and calculation uncertainties. 

#### Method Pools
``` {r, echo = FALSE, warning=FALSE, message=FALSE} 
    source("R/make_table.R")
    overall_tables <- make_EucFACE_table()
    kable(overall_tables$pool, digits=2)

```

#### Method In and out
``` {r, echo = FALSE, warning=FALSE, message=FALSE} 
    kable(overall_tables$inout, digits=2)
```

#### Method NPP
``` {r, echo = FALSE, warning=FALSE, message=FALSE} 
    kable(overall_tables$npp, digits=2)
```

<br/>

### 6.2 Summary by ring
#### Method Pool
``` {r, echo = FALSE, warning=FALSE, message=FALSE} 
    source("R/make_table_by_ring.R")
    tables_by_ring <- make_table_by_ring()
    kable(tables_by_ring$pool, digits=2)

```

#### Method In and out
``` {r, echo = FALSE, warning=FALSE, message=FALSE} 
    kable(tables_by_ring$inout, digits=2)
```

#### Method NPP
``` {r, echo = FALSE, warning=FALSE, message=FALSE} 
    kable(tables_by_ring$npp, digits=2)
```

<br/>

### 6.3 Summary by year
#### Method Pool
``` {r, echo = FALSE, warning=FALSE, message=FALSE} 
    source("R/make_table_by_year.R")
    tables_by_year <- make_EucFACE_table_by_year()
    kable(tables_by_year$pool, digits=2)

```

#### Method In and out
``` {r, echo = FALSE, warning=FALSE, message=FALSE} 
    kable(tables_by_year$inout, digits=2)
```

#### Method NPP
``` {r, echo = FALSE, warning=FALSE, message=FALSE} 
    kable(tables_by_year$npp, digits=2)
```
<br/>
<br/>

# 7. To-do list

    - Mortality data on HIEv, make them a pool - done, but how to extract these trees from live wood? Considering once they are dead, they don't do anything, is it worth to split wood pool into live and dead? 
    - Write meeting summaries and send to John, Remko et al.
    - Met data and soil water data to understand extreme points
    - Calculate leaf C pool based on variable SLA data (need more data from Ben Moore)
    - changes in pools at annual timestep
    - Check if soil C pool includes litter layer or not
    - Check soil C deep layer pools
    - Fineroot C pool decrease over time - is there a waterlogging effect (correlate with soil moisture and Rsoil, check with Sally and Juan)
    - MAESPA output needs to be on a daily basis
    - Overstorey leaf respiration flux - check with Jim for parameters
    - Fineroot respiration flux - more extrapolation is needed, possibly a fraction of Rroot as Rsoil
    - Understorey gpp needs to compare with respiration
    - Herbivory respiration rate can be done using a 2nd method (frass * use efficiency)
    - Leaf production can be estimated based on GPP and litterfall (Remko)
    - Lerp production can be cross checked with leaf NPP to understand its effect
    - Rsoil - what's inter-collar variability? Check with John on its magitude as currently it is quite large. 
    - Make bar plots of NPP, respiration and GPP to see what's the missing C?
    - CH4 calculations (need to understand Loic's calculations)
    - Litter pool based on % live information of understorey?
    - Calculate NEP based on different method
    - Lerp, frass, herbivory consumption and respiration, where do they go?
    - Root mortality and turnover
    - Other missing variables
    - Understorey respiration scaled with CUE, can also work with temperature, but hard to find an appropriate relationship
    - Create error bars

    
<br/>
<br/>
